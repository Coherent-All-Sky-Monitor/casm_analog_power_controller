<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8-Relay Power Controller</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>âš¡ CASM Analog Power Controller</h1>
            <p class="subtitle">Prototype: CH1 Chassis + 11 Backboards (CH1A-K)</p>
            <div class="header-controls">
                <button class="reset-btn" onclick="turnOffAllRelays()">Turn OFF All Relays</button>
                <button class="on-btn" onclick="turnOnAllRelays()">Turn ON All Relays</button>
            </div>
            <div id="status-message" class="health-status"></div>
        </header>

        <div id="relay-grid">
            <!-- Switch controls will be dynamically generated here -->
        </div>

        <!-- curl Command Examples Section -->
        <div class="api-examples">
            <h2>ðŸ“¡ API Usage (curl Commands)</h2>
            
            <div class="example-section">
                <h3>Turn Switch ON/OFF</h3>
                <pre><code># Turn CH1 chassis ON
curl -X POST http://localhost:5001/api/switch/CH1 \
  -H "Content-Type: application/json" \
  -d '{"state": 1}'

# Turn CH1A backboard OFF
curl -X POST http://localhost:5001/api/switch/CH1A \
  -H "Content-Type: application/json" \
  -d '{"state": 0}'</code></pre>
            </div>

            <div class="example-section">
                <h3>Get Switch Status</h3>
                <pre><code># Get CH1 status
curl http://localhost:5001/api/switch/CH1

# Get all switches for chassis 1
curl http://localhost:5001/api/switch/chassis/1

# List all switches
curl http://localhost:5001/api/switch/list</code></pre>
            </div>

            <div class="example-section">
                <h3>Legacy API (by stack/relay number)</h3>
                <pre><code># Still supported for backward compatibility
curl -X POST http://localhost:5001/api/relay/0/1 \
  -H "Content-Type: application/json" \
  -d '{"state": 1}'</code></pre>
            </div>
        </div>
    </div>

    <script>
        // Fetch and render switch states
        async function fetchRelayStates() {
            try {
                const response = await fetch('/api/switch/chassis/1');
                const data = await response.json();
                renderSwitches(data);
            } catch (error) {
                console.error('Error fetching switch states:', error);
                showError('Failed to fetch switch states. Check hardware connection or ensure the Flask server is running.');
            }
        }

        // Render all switches organized by type
        function renderSwitches(data) {
            const grid = document.getElementById('relay-grid');
            grid.innerHTML = '';

            if (!data.switches) {
                showError('No switch data available');
                return;
            }

            // Create chassis section
            const chassisDiv = document.createElement('div');
            chassisDiv.className = 'stack chassis-section';
            
            const chassisHeader = document.createElement('h3');
            chassisHeader.textContent = 'ðŸ”Œ Chassis Control';
            chassisDiv.appendChild(chassisHeader);

            const chassisContainer = document.createElement('div');
            chassisContainer.className = 'relay-container';

            // Add CH1 chassis switch
            const switchName = 'CH1';
            if (data.switches[switchName]) {
                const switchData = data.switches[switchName];
                const switchBtn = document.createElement('button');
                switchBtn.className = `relay chassis ${switchData.state === 1 ? 'on' : 'off'}`;
                switchBtn.textContent = switchName;
                switchBtn.onclick = () => toggleSwitch(switchName, switchData.state);
                chassisContainer.appendChild(switchBtn);
            }

            chassisDiv.appendChild(chassisContainer);
            grid.appendChild(chassisDiv);

            // Create backboards section
            const backboardDiv = document.createElement('div');
            backboardDiv.className = 'stack backboard-section';
            
            const backboardHeader = document.createElement('h3');
            backboardHeader.textContent = 'ðŸ“‹ Backboard Controls (CH1A - CH1K)';
            backboardDiv.appendChild(backboardHeader);

            const backboardContainer = document.createElement('div');
            backboardContainer.className = 'relay-container';

            // Add all backboard switches
            const backboards = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K'];
            backboards.forEach(letter => {
                const switchName = `CH1${letter}`;
                if (data.switches[switchName]) {
                    const switchData = data.switches[switchName];
                    const switchBtn = document.createElement('button');
                    switchBtn.className = `relay backboard ${switchData.state === 1 ? 'on' : 'off'}`;
                    switchBtn.textContent = switchName;
                    switchBtn.onclick = () => toggleSwitch(switchName, switchData.state);
                    backboardContainer.appendChild(switchBtn);
                }
            });

            backboardDiv.appendChild(backboardContainer);
            grid.appendChild(backboardDiv);
        }

        // Toggle switch state using the new API
        async function toggleSwitch(switchName, currentState) {
            const newState = currentState === 1 ? 0 : 1;
            
            try {
                const response = await fetch(`/api/switch/${switchName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state: newState })
                });

                const result = await response.json();
                
                if (response.ok) {
                    fetchRelayStates(); // Refresh the UI
                    showSuccess(result.message || `${switchName} toggled`);
                } else {
                    showError(result.error || 'Failed to toggle switch');
                }
            } catch (error) {
                console.error('Error toggling switch:', error);
                showError('Network error. Check connection to Raspberry Pi.');
            }
        }

        // Turn OFF all relays
        async function turnOffAllRelays() {
            if (!confirm('Are you sure you want to turn OFF all relays?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/relay/all-off', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    fetchRelayStates(); // Refresh the UI
                    showSuccess('All relays turned OFF');
                } else {
                    showError('Failed to turn off relays');
                }
            } catch (error) {
                console.error('Error turning off relays:', error);
                showError('Network error. Check connection.');
            }
        }

        // Turn ON all relays
        async function turnOnAllRelays() {
            if (!confirm('Are you sure you want to turn ON all relays?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/relay/all-on', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();
                
                if (response.ok) {
                    fetchRelayStates(); // Refresh the UI
                    showSuccess('All relays turned ON');
                } else {
                    showError('Failed to turn on relays');
                }
            } catch (error) {
                console.error('Error turning on relays:', error);
                showError('Network error. Check connection.');
            }
        }

        // Show success message
        function showSuccess(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<span class="success">âœ“ ${message}</span>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.innerHTML = `<span class="error">âœ— ${message}</span>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Auto-refresh every 2 seconds
        setInterval(fetchRelayStates, 2000);

        // Initial load
        fetchRelayStates();
    </script>
</body>
</html>
